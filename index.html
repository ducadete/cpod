<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Avaliação Odontológica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos otimizados para mobile */
        .tooth-input {
            width: 3rem; /* Tamanho maior para facilitar o toque */
            height: 3rem;
            text-align: center;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            font-size: 1rem; /* Fonte maior */
            -webkit-appearance: none; /* Remove estilos padrão do iOS */
        }
        .tooth-label {
            font-size: 0.875rem; /* Fonte do número do dente aumentada */
            color: #4B5563;
        }
        .tooth-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-width: 3.5rem; /* Garante espaço para o input */
        }
        #success-message {
            display: none;
            transition: opacity 0.5s ease-in-out;
        }
        /* Estilos para o Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="min-h-screen p-2 sm:p-4">
        <nav class="bg-white shadow-md rounded-lg mb-8 max-w-4xl mx-auto">
            <div class="mx-auto px-4">
                <div class="flex justify-center h-16">
                    <div class="flex items-center">
                        <div class="flex items-baseline space-x-4">
                            <a href="formulario_odontologico.html" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Home</a>
                            <a href="Dashboard.html" class="text-gray-700 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Index</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <form id="evaluation-form" class="w-full max-w-4xl bg-white p-4 sm:p-8 rounded-lg shadow-md mx-auto">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-700 mb-6">Formulário de Avaliação Odontológica</h1>

            <!-- Seção de Identificação -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-gray-800 mb-4">Identificação</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="dentista" class="block text-sm font-medium text-gray-700">Dentista Avaliador</label>
                        <div class="flex items-center gap-2 mt-1">
                            <select id="dentista" name="dentista" class="text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                               <option>Carregando...</option>
                            </select>
                            <button type="button" id="add-dentist-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none">...</button>
                        </div>
                    </div>
                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="text" id="data" name="data" readonly class="mt-1 text-lg block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700">Nome da Criança</label>
                        <input type="text" id="nome" name="nome" class="mt-1 text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="nascimento" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
                        <input type="date" id="nascimento" name="nascimento" class="mt-1 text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                     <div>
                        <label for="idade" class="block text-sm font-medium text-gray-700">Idade (automático)</label>
                        <input type="number" id="idade" name="idade" readonly class="mt-1 text-lg block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gênero</label>
                        <div class="mt-2 flex items-center space-x-6">
                            <label class="inline-flex items-center text-lg">
                                <input type="radio" name="genero" value="masculino" class="h-5 w-5 text-indigo-600">
                                <span class="ml-2">Masculino</span>
                            </label>
                            <label class="inline-flex items-center text-lg">
                                <input type="radio" name="genero" value="feminino" class="h-5 w-5 text-indigo-600">
                                <span class="ml-2">Feminino</span>
                            </label>
                        </div>
                    </div>
                     <div class="md:col-span-2">
                        <label for="escola" class="block text-sm font-medium text-gray-700">Escola</label>
                        <div class="flex items-center gap-2 mt-1">
                            <select id="escola" name="escola" class="text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                               <option>Carregando...</option>
                            </select>
                             <button type="button" id="add-school-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none">...</button>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Seção CPO-D/ceo-d -->
            <fieldset class="border-t border-gray-200 mt-8 pt-6">
                <legend class="text-lg font-semibold text-gray-800 mb-4">1. CPO-D/ceo-d</legend>
                
                <div class="odontogram-container overflow-x-auto pb-4">
                     <!-- Arcada Superior -->
                    <div class="flex flex-wrap justify-center">
                        <div class="flex">
                            <div class="tooth-cell"><span class="tooth-label">18</span><input type="text" data-tooth="18" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">17</span><input type="text" data-tooth="17" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">16</span><input type="text" data-tooth="16" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">15</span><input type="text" data-tooth="15" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">14</span><input type="text" data-tooth="14" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">13</span><input type="text" data-tooth="13" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">12</span><input type="text" data-tooth="12" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">11</span><input type="text" data-tooth="11" class="tooth-input"></div>
                        </div>
                        <div class="flex">
                            <div class="tooth-cell"><span class="tooth-label">21</span><input type="text" data-tooth="21" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">22</span><input type="text" data-tooth="22" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">23</span><input type="text" data-tooth="23" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">24</span><input type="text" data-tooth="24" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">25</span><input type="text" data-tooth="25" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">26</span><input type="text" data-tooth="26" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">27</span><input type="text" data-tooth="27" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">28</span><input type="text" data-tooth="28" class="tooth-input"></div>
                        </div>
                    </div>
                     <!-- Decíduos Superiores -->
                    <div class="flex flex-wrap justify-center mt-2">
                        <div class="flex ml-auto">
                            <div class="tooth-cell"><span class="tooth-label">55</span><input type="text" data-tooth="55" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">54</span><input type="text" data-tooth="54" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">53</span><input type="text" data-tooth="53" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">52</span><input type="text" data-tooth="52" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">51</span><input type="text" data-tooth="51" class="tooth-input"></div>
                        </div>
                        <div class="flex mr-auto">
                            <div class="tooth-cell"><span class="tooth-label">61</span><input type="text" data-tooth="61" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">62</span><input type="text" data-tooth="62" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">63</span><input type="text" data-tooth="63" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">64</span><input type="text" data-tooth="64" class="tooth-input"></div>
                            <div class="tooth-cell"><span class="tooth-label">65</span><input type="text" data-tooth="65" class="tooth-input"></div>
                        </div>
                    </div>

                    <hr class="border-gray-400 my-4 border-dashed">

                    <!-- Decíduos Inferiores -->
                    <div class="flex flex-wrap justify-center mb-2">
                         <div class="flex ml-auto">
                            <div class="tooth-cell"><input type="text" data-tooth="85" class="tooth-input"><span class="tooth-label">85</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="84" class="tooth-input"><span class="tooth-label">84</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="83" class="tooth-input"><span class="tooth-label">83</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="82" class="tooth-input"><span class="tooth-label">82</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="81" class="tooth-input"><span class="tooth-label">81</span></div>
                        </div>
                        <div class="flex mr-auto">
                            <div class="tooth-cell"><input type="text" data-tooth="71" class="tooth-input"><span class="tooth-label">71</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="72" class="tooth-input"><span class="tooth-label">72</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="73" class="tooth-input"><span class="tooth-label">73</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="74" class="tooth-input"><span class="tooth-label">74</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="75" class="tooth-input"><span class="tooth-label">75</span></div>
                        </div>
                    </div>
                     <!-- Arcada Inferior -->
                    <div class="flex flex-wrap justify-center">
                        <div class="flex">
                             <div class="tooth-cell"><input type="text" data-tooth="48" class="tooth-input"><span class="tooth-label">48</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="47" class="tooth-input"><span class="tooth-label">47</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="46" class="tooth-input"><span class="tooth-label">46</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="45" class="tooth-input"><span class="tooth-label">45</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="44" class="tooth-input"><span class="tooth-label">44</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="43" class="tooth-input"><span class="tooth-label">43</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="42" class="tooth-input"><span class="tooth-label">42</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="41" class="tooth-input"><span class="tooth-label">41</span></div>
                        </div>
                        <div class="flex">
                             <div class="tooth-cell"><input type="text" data-tooth="31" class="tooth-input"><span class="tooth-label">31</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="32" class="tooth-input"><span class="tooth-label">32</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="33" class="tooth-input"><span class="tooth-label">33</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="34" class="tooth-input"><span class="tooth-label">34</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="35" class="tooth-input"><span class="tooth-label">35</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="36" class="tooth-input"><span class="tooth-label">36</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="37" class="tooth-input"><span class="tooth-label">37</span></div>
                            <div class="tooth-cell"><input type="text" data-tooth="38" class="tooth-input"><span class="tooth-label">38</span></div>
                        </div>
                    </div>
                </div>

                <!-- Legenda -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-base text-gray-600">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Dentes Permanentes</h3>
                        <ul class="space-y-1">
                            <li><strong>0:</strong> Sadio</li><li><strong>1:</strong> Cariado</li><li><strong>2:</strong> Restaurado, com cárie</li><li><strong>3:</strong> Restaurado, sem cárie</li><li><strong>4:</strong> Extraído (cárie)</li><li><strong>5:</strong> Extraído (outra razão)</li><li><strong>6:</strong> Selante</li><li><strong>7:</strong> Ponte ou coroa</li><li><strong>8:</strong> Não erupcionado</li><li><strong>9:</strong> Excluído</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Dentes Decíduos</h3>
                         <ul class="space-y-1">
                            <li><strong>A:</strong> Sadio</li><li><strong>B:</strong> Cariado</li><li><strong>C:</strong> Restaurado, com cárie</li><li><strong>D:</strong> Restaurado, sem cárie</li><li><strong>E:</strong> Extraído (cárie)</li><li><strong>F:</strong> Selante</li><li><strong>G:</strong> Ponte ou coroa</li>
                        </ul>
                    </div>
                </div>
            </fieldset>
            
            <!-- Seção de Higiene Bucal -->
            <fieldset class="border-t border-gray-200 mt-8 pt-6">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Higiene bucal</label>
                        <div class="mt-2 flex items-center space-x-6">
                            <label class="inline-flex items-center text-lg">
                                <input type="radio" name="higiene" value="satisfatoria" class="h-5 w-5 text-indigo-600">
                                <span class="ml-2">Satisfatória</span>
                            </label>
                            <label class="inline-flex items-center text-lg">
                                <input type="radio" name="higiene" value="insatisfatoria" class="h-5 w-5 text-indigo-600">
                                <span class="ml-2">Insatisfatória</span>
                            </label>
                        </div>
                    </div>
                     <div class="md:col-span-2">
                        <label for="placa" class="block text-sm font-medium text-gray-700">Locais de acúmulo de placa visível</label>
                        <textarea id="placa" name="placa" rows="3" class="mt-1 text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </div>
            </fieldset>

            <!-- Botão de Envio -->
            <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                    Enviar Avaliação
                </button>
            </div>

            <div id="success-message" class="hidden mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg text-center">
                Avaliação salva com sucesso!
            </div>

        </form>
    </div>
    
    <!-- Modal para Cadastrar Escola -->
    <div id="school-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Cadastrar Nova Escola</h2>
            <form id="save-school-form">
                <div class="mb-4">
                    <label for="new-school-name" class="block text-sm font-medium text-gray-700">Nome da Escola</label>
                    <input type="text" id="new-school-name" required class="mt-1 text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="new-health-unit" class="block text-sm font-medium text-gray-700">Unidade de Saúde de Referência</label>
                    <select id="new-health-unit" required class="mt-1 text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecione uma unidade</option>
                        <option value="USF Vila Dutra">USF Vila Dutra</option>
                        <option value="USF Santa Edwirges">USF Santa Edwirges</option>
                        <option value="USF Nove de Julho">USF Nove de Julho</option>
                        <option value="USF Tibiriça">USF Tibiriça</option>
                        <option value="USF Vila São Paulo">USF Vila São Paulo</option>
                        <option value="USF Nova Bauru">USF Nova Bauru</option>
                        <option value="USF Pousada II">USF Pousada II</option>
                        <option value="USF Vargem Limpa">USF Vargem Limpa</option>
                        <option value="USF Jardi Godoy">USF Jardi Godoy</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                     <button type="button" id="close-school-modal-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Fechar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:bg-indigo-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Cadastrar Dentista -->
    <div id="dentist-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Cadastrar Novo Dentista</h2>
            <form id="save-dentist-form">
                <div class="mb-4">
                    <label for="new-dentist-name" class="block text-sm font-medium text-gray-700">Nome do Dentista</label>
                    <input type="text" id="new-dentist-name" required class="mt-1 text-lg block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                     <button type="button" id="close-dentist-modal-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Fechar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:bg-indigo-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCQ6-j_XnXirciqXe1-Me_fPErfWatRgpo",
          authDomain: "cpod-f415e.firebaseapp.com",
          projectId: "cpod-f415e",
          storageBucket: "cpod-f415e.appspot.com",
          messagingSenderId: "1074454483835",
          appId: "1:1074454483835:web:43e95d040e885d293363de",
          measurementId: "G-PM5E4T0ZYC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Sign in user anonymously
        signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
        });

        const escolaSelect = document.getElementById('escola');
        const dentistaSelect = document.getElementById('dentista');

        const initialDentists = [
            "AKIMI ADACHI", "BARBARA ARRABAL BARROS FERREIRA", "CAIO FARIA DE MORAES",
            "DOUGLAS ARAUJO PEDROLONGO", "FRANCINE RODRIGUES DO NASCIMENTO", "GIOVANA SASSO JONAS",
            "ISABELA MORENO AYRES", "ISRAEL MESSIAS GUARDIA", "JULIA FICHIO MIYAHARA",
            "JULIA SANCHES DE SOUZA", "JULIA TELLES PASCON", "JULIANE PANDOLFI BUENO DE SOUZA ANTONIO",
            "LIVIA MOZARDO CASTIGLIO", "LORRAYNE FARIAS DOS SANTOS", "LUZIA APARECIDA KIOKO FUGIYAMA",
            "MATHEUS CAMARGO MARCIANO", "MAYARA MONTOVANI DE OLIVEIRA", "MONY KELLY DA SILVA BEZERRA",
            "NAYANE MARIA DE MELO ALEXANDRINO", "PRISCILA CALIGARIS CAGI", "THAIS NAYRA MACHADO"
        ];

        async function loadDentists() {
            try {
                const dentistsCollection = collection(db, "dentistas");
                let querySnapshot = await getDocs(dentistsCollection);

                if (querySnapshot.empty) {
                    const promises = initialDentists.map(name => addDoc(dentistsCollection, { nome: name }));
                    await Promise.all(promises);
                    querySnapshot = await getDocs(dentistsCollection);
                }

                const dentists = [];
                querySnapshot.forEach((doc) => {
                    dentists.push(doc.data().nome);
                });
                
                dentistaSelect.innerHTML = '<option value="">Selecione um dentista</option>';
                dentists.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dentistaSelect.appendChild(option);
                });

            } catch (error) {
                console.error("Erro ao carregar dentistas: ", error);
                dentistaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function loadSchools() {
            try {
                const querySnapshot = await getDocs(collection(db, "escolas"));
                escolaSelect.innerHTML = '<option value="">Selecione uma escola</option>';
                querySnapshot.forEach((doc) => {
                    const school = doc.data();
                    const option = document.createElement('option');
                    option.value = school.nome;
                    option.textContent = school.nome;
                    escolaSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar escolas: ", error);
                escolaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSchools();
            loadDentists();

            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('data').value = `${day}/${month}/${year}`;

            document.getElementById('nascimento').addEventListener('change', function() {
                const birthDate = this.value;
                if (birthDate) {
                    const today = new Date();
                    const birthDateObj = new Date(birthDate);
                    let age = today.getFullYear() - birthDateObj.getFullYear();
                    const monthDifference = today.getMonth() - birthDateObj.getMonth();
                    if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDateObj.getDate())) {
                        age--;
                    }
                    document.getElementById('idade').value = age >= 0 ? age : '';
                } else {
                    document.getElementById('idade').value = '';
                }
            });
        });

        // School Modal Logic
        const schoolModal = document.getElementById('school-modal');
        const addSchoolBtn = document.getElementById('add-school-btn');
        const closeSchoolModalBtn = document.getElementById('close-school-modal-btn');
        const saveSchoolForm = document.getElementById('save-school-form');

        addSchoolBtn.addEventListener('click', () => schoolModal.classList.remove('hidden'));
        closeSchoolModalBtn.addEventListener('click', () => schoolModal.classList.add('hidden'));

        saveSchoolForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const schoolName = document.getElementById('new-school-name').value;
            const healthUnit = document.getElementById('new-health-unit').value;

            if (!schoolName || !healthUnit) return;

            try {
                await addDoc(collection(db, "escolas"), { nome: schoolName, unidadeSaude: healthUnit });
                saveSchoolForm.reset();
                schoolModal.classList.add('hidden');
                await loadSchools();
                escolaSelect.value = schoolName;
            } catch (error) {
                console.error("Erro ao salvar escola: ", error);
            }
        });

        // Dentist Modal Logic
        const dentistModal = document.getElementById('dentist-modal');
        const addDentistBtn = document.getElementById('add-dentist-btn');
        const closeDentistModalBtn = document.getElementById('close-dentist-modal-btn');
        const saveDentistForm = document.getElementById('save-dentist-form');

        addDentistBtn.addEventListener('click', () => dentistModal.classList.remove('hidden'));
        closeDentistModalBtn.addEventListener('click', () => dentistModal.classList.add('hidden'));

        saveDentistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const dentistName = document.getElementById('new-dentist-name').value;
            if (!dentistName) return;

            try {
                await addDoc(collection(db, "dentistas"), { nome: dentistName });
                saveDentistForm.reset();
                dentistModal.classList.add('hidden');
                await loadDentists();
                dentistaSelect.value = dentistName;
            } catch (error) {
                console.error("Erro ao salvar dentista: ", error);
            }
        });


        // Main Form Submission Logic
        const form = document.getElementById('evaluation-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const odontogram = {};
            const toothInputs = document.querySelectorAll('.tooth-input');
            toothInputs.forEach(input => {
                if(input.value) {
                    odontogram[input.dataset.tooth] = input.value;
                }
            });

            const evaluationData = {
                dentista: form.dentista.value,
                data: form.data.value,
                nomeCrianca: form.nome.value,
                dataNascimento: form.nascimento.value,
                idade: form.idade.value,
                genero: form.genero.value,
                escola: form.escola.value,
                higieneBucal: form.higiene.value,
                locaisPlaca: form.placa.value,
                odontograma: odontogram,
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, "avaliacoes"), evaluationData);
                
                const successMessage = document.getElementById('success-message');
                successMessage.style.display = 'block';
                successMessage.style.opacity = 1;
                form.reset();

                 const today = new Date();
                 const day = String(today.getDate()).padStart(2, '0');
                 const month = String(today.getMonth() + 1).padStart(2, '0');
                 const year = today.getFullYear();
                 document.getElementById('data').value = `${day}/${month}/${year}`;
                 
                 loadSchools();
                 loadDentists();

                setTimeout(() => {
                    successMessage.style.opacity = 0;
                    setTimeout(() => {
                         successMessage.style.display = 'none';
                    }, 500);
                }, 3000);

            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });
    </script>
</body>
</html>


